# Система управления библиотекой API

RESTful API для управления библиотечной системой, построенный с использованием FastAPI, SQLAlchemy и PostgreSQL.

## Возможности

- JWT Аутентификация для библиотекарей
- CRUD операции для книг и читателей
- Система выдачи книг с бизнес-правилами
- Миграции базы данных с помощью Alembic
- Комплексный набор тестов

## Структура проекта

```
.
├── app/
│   ├── models.py      # SQLAlchemy модели
│   ├── schemas.py     # Pydantic схемы
│   ├── database.py    # Конфигурация базы данных
│   ├── auth.py        # Утилиты аутентификации
│   └── main.py        # FastAPI приложение и маршруты
├── tests/
│   └── test_main.py   # Набор тестов
├── Dockerfile         # Конфигурация Docker
├── docker-compose.yml # Конфигурация Docker Compose
├── requirements.txt   # Зависимости проекта
└── README.md
```

## Структура базы данных

Система использует следующие таблицы:

1. `users` - Хранит информацию аутентификации библиотекарей
   - id (Первичный ключ)
   - email (уникальный)
   - hashed_password (хешированный пароль)
   - is_active (активен ли пользователь)

2. `books` - Хранит информацию о книгах
   - id (Первичный ключ)
   - title (название)
   - author (автор)
   - publication_year (год публикации, необязательно)
   - isbn (уникальный, необязательно)
   - copies_available (доступное количество)
   - description (описание, необязательно)

3. `readers` - Хранит информацию о читателях
   - id (Первичный ключ)
   - name (имя)
   - email (уникальный)

4. `borrowed_books` - Отслеживает выдачу книг
   - id (Первичный ключ)
   - book_id (Внешний ключ)
   - reader_id (Внешний ключ)
   - borrow_date (дата выдачи)
   - return_date (дата возврата)

## Установка и запуск с Docker

1. Клонируйте репозиторий
2. Перейдите в директорию проекта
3. Запустите приложение с помощью Docker Compose:
   ```bash
   docker-compose up --build
   ```

Приложение будет доступно по адресу http://localhost:8000

## Регистрация первого пользователя

Для регистрации первого библиотекаря выполните:

```bash
curl -X POST "http://localhost:8000/register/" \
     -H "Content-Type: application/json" \
     -d '{"email": "librarian@example.com", "password": "your-password"}'
```

## API Документация

После запуска сервера посетите:
- http://localhost:8000/docs для Swagger UI
- http://localhost:8000/redoc для ReDoc

## Запуск тестов

```bash
docker-compose run web pytest tests/
```

## Реализация бизнес-логики

1. Проверка доступности книги
   - Перед выдачей книги система проверяет, что copies_available > 0
   - При выдаче книги copies_available уменьшается на 1
   - При возврате книги copies_available увеличивается на 1

2. Лимит на количество книг у читателя
   - Система отслеживает активные выдачи для каждого читателя
   - Перед выдачей проверяется, что у читателя менее 3 активных выдач
   - Активными считаются выдачи, где return_date равен NULL

3. Валидация возврата книги
   - Система проверяет, что книга была выдана именно этому читателю
   - Проверяет, что книга еще не была возвращена
   - Обновляет return_date и copies_available при успешном возврате

## Возможные дополнительные функции

Предлагаемое улучшение - реализация системы уведомлений:

1. Отправка email-уведомлений читателям когда:
   - Срок возврата книги подходит к концу
   - Есть просроченные книги
   - Запрошенная книга стала доступна

2. Подход к реализации:
   - Добавление поля due_date в таблицу borrowed_books
   - Создание таблицы notification_preferences для читателей
   - Использование планировщика фоновых задач (например, Celery)
   - Интеграция с email-сервисом (например, SendGrid)
   - Добавление настроек уведомлений в профили читателей 